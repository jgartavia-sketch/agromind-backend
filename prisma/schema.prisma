generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farms Farm[]
}

model Farm {
  id              String @id @default(cuid())
  userId          String
  name            String
  view            Json?
  preferredCenter Json?

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  points    MapPoint[]
  lines     MapLine[]
  zones     MapZone[]
  tasks     Task[]
  movements FinanceMovement[]

  // ✅ PASO 2: Activos (debajo de Finanzas) — ÚNICA fuente de verdad
  assets Asset[]

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, isPrimary])
}

model MapPoint {
  id        String   @id @default(cuid())
  farmId    String
  name      String?
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, updatedAt])
}

model MapLine {
  id        String   @id @default(cuid())
  farmId    String
  name      String?
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, updatedAt])
}

model MapZone {
  id         String  @id @default(cuid())
  farmId     String
  name       String?
  data       Json
  components Json?

  // ✅ NUEVO: fecha de última actualización de NOTAS (no se mezcla con updatedAt general)
  notesUpdatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, updatedAt])
  @@index([farmId, notesUpdatedAt])
}

model Task {
  id       String  @id @default(cuid())
  farmId   String
  title    String
  zone     String?
  type     String
  priority String

  // ✅ fecha inicio (YA obligatoria)
  start DateTime

  // ✅ fecha de vencimiento
  due DateTime

  status    String
  owner     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, start])
  @@index([farmId, due])
}

model FinanceMovement {
  id     String @id @default(cuid())
  farmId String

  date     DateTime
  concept  String
  category String
  type     String
  amount   Float
  note     String?

  // ✅ número de factura (opcional)
  invoiceNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, date])
  @@index([farmId, type])
}

/////////////////////////////////////////////////////////////
// ✅ PASO 2: ACTIVOS (Assets) — finanzas reales, producción
/////////////////////////////////////////////////////////////

model Asset {
  id     String @id @default(cuid())
  farmId String

  name     String
  category String @default("Equipos")

  purchaseValue Float
  purchaseDate  DateTime @default(now())

  // Vida útil contable (años)
  usefulLifeYears Int @default(1)

  // Valor residual (salvamento)
  residualValue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([farmId, purchaseDate])
  @@index([farmId, category])
}
